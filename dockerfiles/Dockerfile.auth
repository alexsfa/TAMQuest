FROM supabase/gotrue:v2.157.0

USER root

ADD https://github.com/jwilder/dockerize/releases/download/v0.6.1/dockerize-linux-amd64-v0.6.1.tar.gz /tmp/dockerize.tar.gz
RUN apk add --no-cache curl && tar -C /usr/local/bin -xzvf /tmp/dockerize.tar.gz && rm /tmp/dockerize.tar.gz

USER supabase

# waits until it can successfully connect to the db and then runs gotrue
# gotrue will apply all the users,schema migration on the db
ENTRYPOINT ["dockerize", "-wait", "tcp://db:5432", "-timeout", "30s", "--"] 
CMD ["gotrue"]